!function(){"use strict";if("function"!=typeof Chess||"function"!=typeof Chessboard||!window.PGNCore)return;var e=window.PGNCore;function t(e,t){t&&e.appendChild(document.createTextNode(t))}function n(e){var t=e.split(/\r?\n/),n=[],r=[],o=!0;return t.forEach(function(e){var t=e.trim();o&&t.startsWith("[")&&t.endsWith("]")?n.push(e):o&&""===t?o=!1:(o=!1,r.push(e))}),{headers:n,moveText:r.join(" ").replace(/\s+/g," ").trim()}}class r{constructor(e){this.sourceEl=e,this.wrapper=document.createElement("div"),this.wrapper.className="pgn-reader-block",this.finalResultPrinted=!1,this.build(),this.applyFigurines(),this.initBoard(),this.bindMoveClicks()}static isSAN(e){return e.PGNCore?PGNCore.SAN_CORE_REGEX.test(e):!1}build(){var r=e.normalizeFigurines(this.sourceEl.textContent.trim()),{headers:o,moveText:a}=n(r);this.wrapper.innerHTML='<div class="pgn-reader-header"></div><div class="pgn-reader-cols"><div class="pgn-reader-left"><div class="pgn-reader-board"></div><div class="pgn-reader-buttons"><button class="pgn-reader-btn pgn-reader-prev">◀</button><button class="pgn-reader-btn pgn-reader-next">▶</button></div></div><div class="pgn-reader-right"></div></div>',this.sourceEl.replaceWith(this.wrapper),this.headerDiv=this.wrapper.querySelector(".pgn-reader-header"),this.movesCol=this.wrapper.querySelector(".pgn-reader-right"),this.headerDiv.appendChild(this.buildHeader(new Chess().header()||{})),this.parse(a)}buildHeader(n){var r=document.createElement("h3"),o=(n.WhiteTitle?n.WhiteTitle+" ":"")+e.flipName(n.White||"")+(n.WhiteElo?" ("+n.WhiteElo+")":""),a=(n.BlackTitle?n.BlackTitle+" ":"")+e.flipName(n.Black||"")+(n.BlackElo?" ("+n.BlackElo+")":""),i=e.extractYear(n.Date),s=(n.Event||"")+(i?", "+i:"");return t(r,o+" – "+a),r.appendChild(document.createElement("br")),t(r,s),r}ensure(e,t){e.container||(e.container=document.createElement("p"),e.container.className=t,this.movesCol.appendChild(e.container))}handleSAN(n,r){var o=n.replace(/[^a-hKQRBN0-9=O0-]+$/g,"").replace(/0/g,"O");if(!e.SAN_CORE_REGEX.test(o))return t(r.container,n+" "),null;var a=r.chess.history().length,i=0==a%2,s=Math.floor(a/2)+1;i?t(r.container,s+"."+e.NBSP):r.lastWasInterrupt&&t(r.container,s+"..."+e.NBSP),r.prevFen=r.chess.fen();var l=r.chess.move(o,{sloppy:!0});if(!l)return t(r.container,n+" "),null;r.lastWasInterrupt=!1;var c=document.createElement("span");return c.className="pgn-move reader-move",c.dataset.fen=r.chess.fen(),c.dataset.mainline="main"===r.type?"1":"0",c.textContent=e.makeCastlingUnbreakable(n)+" ",r.container.appendChild(c),c}parse(e){var n=new Chess,r={type:"main",chess:n,container:null,parent:null,lastWasInterrupt:!1,prevFen:n.fen()},o=0;for(;o<e.length;){var a=e[o];if(/\s/.test(a)){for(;o<e.length&&/\s/.test(e[o]);)o++;this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation"),t(r.container," ");continue}for(var i=o;o<e.length&&!/\s/.test(e[o])&&-1==="(){}".indexOf(e[o]);)o++;var s=e.substring(i,o);if(!s)continue;this.ensure(r,"main"===r.type?"pgn-mainline":"pgn-variation");var l=this.handleSAN(s,r);l||t(r.container,e.makeCastlingUnbreakable(s)+" ")}}applyFigurines(){var e={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};this.wrapper.querySelectorAll(".pgn-move").forEach(function(t){var n=t.textContent.match(/^([KQRBN])(.+)/);n&&(t.textContent=e[n[1]]+n[2])})}initBoard(){this.board=Chessboard(this.wrapper.querySelector(".pgn-reader-board"),{position:"start",draggable:!1,pieceTheme:e.PIECE_THEME_URL}),this.moves=[...this.wrapper.querySelectorAll(".reader-move")],this.mainline=this.moves.filter(e=>"1"===e.dataset.mainline),this.idx=0,this.goto(this.mainline[0])}goto(e){e&&this.board.position(e.dataset.fen,!1),this.moves.forEach(t=>t.classList.toggle("reader-move-active",t===e))}bindMoveClicks(){this.moves.forEach(e=>e.addEventListener("click",()=>this.goto(e)))}prev(){this.idx=Math.max(0,this.idx-1),this.goto(this.mainline[this.idx])}next(){this.idx=Math.min(this.mainline.length-1,this.idx+1),this.goto(this.mainline[this.idx])}}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("pgn-reader").forEach(e=>new r(e))})}();