<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<!-- jQuery REQUIRED by chessboard.js -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

<!-- Chess libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1115;
  color:#e6e6e6;
  font-family:system-ui,-apple-system,sans-serif;
}
.top{
  padding:10px 14px;
  background:#171a21;
  border-bottom:1px solid #222;
  display:flex;
  align-items:center;
  gap:10px;
}
.top img{width:22px;height:22px;filter:invert(1)}
.top .title{font-weight:700}

.wrap{padding:12px;display:flex;flex-direction:column;gap:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
#board{width:min(92vw,560px);margin:0 auto}

.controls{
  width:min(92vw,560px);
  margin:0 auto;
  display:flex;
  gap:6px;
}
.controls button{
  flex:1;
  padding:10px 0;
  border:none;
  border-radius:10px;
  background:#1f2430;
  color:#ddd;
  cursor:pointer;
}
.controls button:disabled{opacity:.4;cursor:default}

.card{
  border:1px solid #222;
  border-radius:12px;
  overflow:hidden;
  background:#0f1115;
}
.tabsHead{
  display:flex;
  gap:6px;
  padding:10px 12px;
  background:#141820;
  border-bottom:1px solid #222;
  align-items:center;
  justify-content:space-between;
}
.tabs{display:flex;gap:6px}
.tabBtn{
  border:none;
  background:#1f2430;
  color:#ddd;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
}
.tabBtn.active{background:#3a7afe;color:#fff}
.card .body{padding:12px}

.moves{font-size:18px;line-height:2.05;word-break:break-word}
.move{
  display:inline-block;
  padding:2px 6px;
  border-radius:7px;
  cursor:pointer;
  user-select:none;
}
.move:hover{background:#20263a}
.move.active{background:#3a7afe;color:#fff}

.variation{
  margin:6px 0 10px 26px;
  padding-left:10px;
  border-left:2px dashed #444;
  opacity:.95;
}

.commentRow{
  margin:4px 0 10px 18px;
  padding:6px 8px;
  border-left:3px solid #3a7afe;
  border-radius:8px;
  background:#121724;
  color:#cfd6ff;
  font-size:14px;
}

.pgnBox{
  width:100%;
  height:320px;
  resize:vertical;
  border-radius:12px;
  border:1px solid #222;
  background:#0f1115;
  color:#e6e6e6;
  padding:12px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-size:14px;
}
.pgnActions{display:flex;gap:8px;margin-top:10px}
.pgnActions button{
  flex:1;
  padding:10px 0;
  border:none;
  border-radius:10px;
  background:#1f2430;
  color:#ddd;
  cursor:pointer;
}

/* Tooltip */
#pop{
  position:fixed;
  z-index:9999;
  background:#0b0f18;
  border:1px solid #2a3350;
  border-radius:12px;
  box-shadow:0 16px 50px rgba(0,0,0,.55);
  padding:8px;
  display:none;
  min-width:170px;
}
#pop .row{display:flex;gap:8px;align-items:center}
.popBtn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:36px;
  height:36px;
  border-radius:10px;
  border:none;
  background:#1f2430;
  color:#e6e6e6;
  cursor:pointer;
  font-size:18px;
}
.popBtn:hover{background:#2a3150}
.popLabel{font-size:12px;opacity:.75;margin:6px 2px 0}
.popInputRow{display:flex;gap:8px;margin-top:8px}
.popInputRow input{
  flex:1;
  border-radius:10px;
  border:1px solid #2a3350;
  background:#0f1115;
  color:#e6e6e6;
  padding:10px;
  font-size:14px;
}
.popSave{
  width:44px;
  height:42px;
  border-radius:10px;
  border:none;
  background:#3a7afe;
  color:#fff;
  cursor:pointer;
  font-size:16px;
}
.popPieces{display:flex;gap:8px;margin-top:8px}
.popPieceBtn{
  flex:1;
  height:44px;
  border-radius:12px;
  border:1px solid #2a3350;
  background:#121724;
  color:#e6e6e6;
  cursor:pointer;
  font-size:22px;
}
.popPieceBtn:hover{background:#1b2340}
</style>
</head>

<body>

<div class="top">
  <img src="https://jekyllchess.github.io/assets/favicon.png" alt="">
  <div class="title">JekyllChess PGN App</div>
</div>

<div class="wrap">
  <div class="main">

    <div>
      <div id="board"></div>
      <div class="controls">
        <button id="btnStart" type="button">‚èÆ</button>
        <button id="btnPrev"  type="button">‚óÄ</button>
        <button id="btnNext"  type="button">‚ñ∂</button>
        <button id="btnEnd"   type="button">‚è≠</button>
      </div>
    </div>

    <div class="card">
      <div class="tabsHead">
        <div style="font-weight:700">Move list</div>
        <div class="tabs">
          <button id="tabMoves" class="tabBtn active" type="button">Move list</button>
          <button id="tabPGN" class="tabBtn" type="button">PGN text</button>
        </div>
      </div>

      <div class="body" id="paneMoves">
        <div class="moves" id="moves"></div>
      </div>

      <div class="body" id="panePGN" style="display:none">
        <textarea id="pgnText" class="pgnBox" spellcheck="false"></textarea>
        <div class="pgnActions">
          <button id="copyPGN" type="button">Copy PGN</button>
          <button id="copyFEN" type="button">Copy FEN</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="pop"></div>

<script>
(() => {
  const FIG = { K:"‚ôî", Q:"‚ôï", R:"‚ôñ", B:"‚ôó", N:"‚ôò" };
  const figSAN = (s) => (s||"")
    .replace(/^[KQRBN]/, p => FIG[p] || p)
    .replace(/=([QRBN])/g, (_,p)=>"="+(FIG[p]||p));

  // ---------- Tree ----------
  let NODE_SEQ = 1;
  const byId = new Map();
  class Node {
    constructor(san=null, parent=null){
      this.id = "n" + (NODE_SEQ++);
      this.san = san;
      this.comment = "";
      this.parent = parent;
      this.next = null;
      this.variations = [];
      byId.set(this.id, this);
    }
  }
  const root = new Node(null, null);
  let cursor = root;
  let navNode = null;
  let currentFEN = "start";

  // ---------- Chess / Board ----------
  const chess = new Chess();
  const board = Chessboard("board", {
    position: "start",
    draggable: true,
    pieceTheme: "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
    onDrop: onDrop
  });

  function setBoardFen(fen, animate){
    currentFEN = fen;
    board.position(fen, !!animate);
  }

  function chainToRoot(n){
    const chain = [];
    while(n && n !== root){ chain.push(n); n = n.parent; }
    chain.reverse();
    return chain;
  }

  function rebuildChessToNode(target, animate=true){
    chess.reset();
    if(!target || target === root){
      setBoardFen("start", animate);
      return;
    }
    const chain = chainToRoot(target);
    for(const mv of chain) chess.move(mv.san);
    setBoardFen(chess.fen(), animate);
  }

  function isOnMainline(node){
    let n = root.next;
    while(n){ if(n.id === node.id) return true; n = n.next; }
    return false;
  }

  // ---------- Tabs ----------
  const tabMoves = document.getElementById("tabMoves");
  const tabPGN   = document.getElementById("tabPGN");
  const paneMoves = document.getElementById("paneMoves");
  const panePGN   = document.getElementById("panePGN");

  function showTab(which){
    const movesOn = which === "moves";
    tabMoves.classList.toggle("active", movesOn);
    tabPGN.classList.toggle("active", !movesOn);
    paneMoves.style.display = movesOn ? "" : "none";
    panePGN.style.display   = movesOn ? "none" : "";
  }
  tabMoves.addEventListener("click", (e)=>{ e.stopPropagation(); showTab("moves"); });
  tabPGN.addEventListener("click",   (e)=>{ e.stopPropagation(); showTab("pgn"); });

  // ---------- Tooltip (pop) ----------
  const pop = document.getElementById("pop");
  let popState = { mode:null, nodeId:null, promo:null };

  function hidePop(){
    pop.style.display = "none";
    pop.innerHTML = "";
    popState = { mode:null, nodeId:null, promo:null };
  }
  pop.addEventListener("mousedown", e => e.stopPropagation());
  pop.addEventListener("click", e => e.stopPropagation());
  document.addEventListener("mousedown", () => hidePop());

  function placePopNear(el){
    const r = el.getBoundingClientRect();
    const x = r.left + r.width/2;
    const y = r.top;
    pop.style.left = x + "px";
    pop.style.top  = (y - 10) + "px";
    pop.style.transform = "translate(-50%, -100%)";
  }

  function placePopCenterBoard(){
    const r = document.getElementById("board").getBoundingClientRect();
    pop.style.left = (r.left + r.width/2) + "px";
    pop.style.top  = (r.top + r.height/2) + "px";
    pop.style.transform = "translate(-50%, -50%)";
  }

  function openMovePop(nodeId, anchorEl){
    const node = byId.get(nodeId);
    if(!node || node === root) return;

    const parent = node.parent;
    const isVarRoot = !!(parent && parent.variations.some(v => v.id === node.id));
    const canPromote = isVarRoot;

    popState.mode = "move";
    popState.nodeId = nodeId;

    pop.innerHTML = `
      <div class="row">
        ${canPromote ? `<button class="popBtn" id="popPromote" title="Promote variation">‚¨Ü</button>` : ``}
        <button class="popBtn" id="popComment" title="Add comment">Ôºã</button>
        <button class="popBtn" id="popDelete" title="Delete">üóë</button>
      </div>
      <div class="popLabel">Options</div>
      <div id="popCommentBox" style="display:none">
        <div class="popInputRow">
          <input id="popCommentInput" maxlength="80" placeholder="Short comment‚Ä¶">
          <button class="popSave" id="popCommentSave" title="Save">‚úì</button>
        </div>
      </div>
    `;
    placePopNear(anchorEl);
    pop.style.display = "";

    const btnPromote = document.getElementById("popPromote");
    const btnComment = document.getElementById("popComment");
    const btnDelete  = document.getElementById("popDelete");

    if(btnPromote){
      btnPromote.onclick = (e)=>{ e.stopPropagation(); promoteVariation(parent.id, node.id); hidePop(); };
    }
    btnDelete.onclick = (e)=>{ e.stopPropagation(); deleteNode(node.id); hidePop(); };

    btnComment.onclick = (e)=> {
      e.stopPropagation();
      const box = document.getElementById("popCommentBox");
      const input = document.getElementById("popCommentInput");
      const save = document.getElementById("popCommentSave");
      box.style.display = "";
      input.value = node.comment || "";
      input.focus();

      const doSave = () => {
        node.comment = (input.value||"").replace(/\}/g,"").trim();
        renderAll();
        syncPGN();
        hidePop();
      };

      save.onclick = (ev)=>{ ev.stopPropagation(); doSave(); };
      input.onkeydown = (ev)=>{
        if(ev.key === "Enter"){ ev.preventDefault(); doSave(); }
        if(ev.key === "Escape"){ ev.preventDefault(); hidePop(); }
      };
    };
  }

  function openPromotionPop(pending){
    popState.mode = "promo";
    popState.promo = pending;

    pop.innerHTML = `
      <div class="popLabel" style="margin:0 2px 6px;">Promote to</div>
      <div class="popPieces">
        <button class="popPieceBtn" data-p="q" title="Queen">‚ôï</button>
        <button class="popPieceBtn" data-p="r" title="Rook">‚ôñ</button>
        <button class="popPieceBtn" data-p="b" title="Bishop">‚ôó</button>
        <button class="popPieceBtn" data-p="n" title="Knight">‚ôò</button>
      </div>
      <div class="popLabel">Esc to cancel</div>
    `;
    placePopCenterBoard();
    pop.style.display = "";

    pop.querySelectorAll(".popPieceBtn").forEach(btn => {
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        commitPromotion(btn.getAttribute("data-p"));
      });
    });
  }

  document.addEventListener("keydown", (e)=>{
    if(pop.style.display !== "none" && e.key === "Escape"){
      hidePop();
    }
  });

  // ---------- Variation promotion / delete ----------
  function promoteVariation(branchParentId, variationRootId){
    const parent = byId.get(branchParentId);
    const vNode = byId.get(variationRootId);
    if(!parent || !vNode) return;

    const idx = parent.variations.findIndex(x => x.id === vNode.id);
    if(idx < 0) return;

    const currentMain = parent.next;
    if(currentMain && currentMain.id === vNode.id) return;

    parent.variations.splice(idx, 1);

    if(currentMain){
      parent.variations.unshift(currentMain);
      currentMain.parent = parent;
    }

    parent.next = vNode;
    vNode.parent = parent;

    renderAll();
    rebuildChessToNode(cursor, false);
    syncPGN();
    updateNavButtons();
  }

  function deleteNode(nodeId){
    const node = byId.get(nodeId);
    if(!node || node === root) return;

    const parent = node.parent;
    if(!parent) return;

    if(parent.next && parent.next.id === node.id){
      parent.next = null;
    }else{
      const idx = parent.variations.findIndex(v => v.id === node.id);
      if(idx >= 0) parent.variations.splice(idx, 1);
    }

    cursor = parent;
    navNode = isOnMainline(cursor) ? cursor : null;

    rebuildChessToNode(cursor, true);
    renderAll();
    syncPGN();
    updateNavButtons();
    highlightActive(cursor === root ? "" : cursor.id);
  }

  // ---------- Rendering ----------
  const movesDiv = document.getElementById("moves");
  const pgnText  = document.getElementById("pgnText");

  function highlightActive(nodeId){
    document.querySelectorAll(".move").forEach(el=>el.classList.remove("active"));
    if(!nodeId) return;
    const el = document.querySelector(`.move[data-node-id="${nodeId}"]`);
    if(el) el.classList.add("active");
  }

  function renderLine(startNode, container, ply){
    let node = startNode.next;
    let localPly = ply;

    while(node){
      const span = document.createElement("span");
      span.className = "move";
      span.dataset.nodeId = node.id;

      const isWhite = (localPly % 2 === 0);
      const moveNo = Math.floor(localPly/2) + 1;
      span.textContent = (isWhite ? `${moveNo}. ` : "") + figSAN(node.san) + " ";

      span.onclick = (e)=>{
        e.stopPropagation();
        cursor = node;
        if(isOnMainline(node)) navNode = node;
        rebuildChessToNode(node, true);
        highlightActive(node.id);
        updateNavButtons();
        openMovePop(node.id, span);
      };
      container.appendChild(span);

      if(node.comment && node.comment.trim()){
        const c = document.createElement("div");
        c.className = "commentRow";
        c.textContent = node.comment;
        container.appendChild(c);
      }

      if(node.variations.length){
        node.variations.forEach(vRoot=>{
          const vDiv = document.createElement("div");
          vDiv.className = "variation";

          const vSpan = document.createElement("span");
          vSpan.className = "move";
          vSpan.dataset.nodeId = vRoot.id;
          vSpan.textContent = figSAN(vRoot.san) + " ";
          vSpan.onclick = (e)=>{
            e.stopPropagation();
            cursor = vRoot;
            rebuildChessToNode(vRoot, true);
            highlightActive(vRoot.id);
            updateNavButtons();
            openMovePop(vRoot.id, vSpan);
          };
          vDiv.appendChild(vSpan);

          if(vRoot.comment && vRoot.comment.trim()){
            const cc = document.createElement("div");
            cc.className = "commentRow";
            cc.textContent = vRoot.comment;
            vDiv.appendChild(cc);
          }

          renderLine(vRoot, vDiv, localPly + 1);
          container.appendChild(vDiv);
        });
      }

      node = node.next;
      localPly++;
    }
  }

  function renderAll(){
    movesDiv.innerHTML = "";
    renderLine(root, movesDiv, 0);
  }

  // ---------- PGN ----------
  function serializeFrom(node, startPly, variationStart){
    let out = [];
    let ply = startPly;
    let cur = node.next;
    let first = true;

    while(cur){
      const moveNo = Math.floor(ply/2) + 1;
      const isWhite = (ply % 2 === 0);

      if(first){
        if(variationStart) out.push(isWhite ? `${moveNo}.` : `${moveNo}...`);
        else if(isWhite) out.push(`${moveNo}.`);
      }else{
        if(isWhite) out.push(`${moveNo}.`);
      }

      out.push(cur.san);

      if(cur.comment && cur.comment.trim()){
        out.push(`{${cur.comment.replace(/\}/g,"")}}`);
      }

      if(cur.variations.length){
        cur.variations.forEach(v=>{
          out.push("(" + serializeFrom({next:v}, ply+1, true) + ")");
        });
      }

      first = false;
      ply++;
      cur = cur.next;
    }
    return out.join(" ").trim();
  }

  function syncPGN(){
    const movetext = serializeFrom(root, 0, false);
    pgnText.value = (movetext ? (movetext + " *") : "*") + "\n";
  }

  // ---------- Navigation ----------
  const btnStart = document.getElementById("btnStart");
  const btnPrev  = document.getElementById("btnPrev");
  const btnNext  = document.getElementById("btnNext");
  const btnEnd   = document.getElementById("btnEnd");

  function mainlineNodes(){
    const arr = [];
    let n = root.next;
    while(n){ arr.push(n); n = n.next; }
    return arr;
  }

  function updateNavButtons(){
    const arr = mainlineNodes();
    const has = arr.length > 0;

    btnStart.disabled = !has;
    btnEnd.disabled   = !has;

    btnPrev.disabled  = !has || !navNode;
    // keep Next enabled if there are moves; it will clamp at end
    btnNext.disabled  = !has;
  }

  function goStart(){
    navNode = null;
    cursor = root;
    rebuildChessToNode(root, true);
    highlightActive("");
    updateNavButtons();
  }

  function goEnd(){
    const arr = mainlineNodes();
    if(!arr.length) return goStart();
    navNode = arr[arr.length-1];
    cursor = navNode;
    rebuildChessToNode(navNode, true);
    highlightActive(navNode.id);
    updateNavButtons();
  }

  function goPrev(){
    const arr = mainlineNodes();
    if(!arr.length || !navNode) return;
    const idx = arr.findIndex(x => x.id === navNode.id);
    if(idx <= 0) return goStart();
    navNode = arr[idx-1];
    cursor = navNode;
    rebuildChessToNode(navNode, true);
    highlightActive(navNode.id);
    updateNavButtons();
  }

  function goNext(){
    const arr = mainlineNodes();
    if(!arr.length) return;
    if(!navNode) navNode = arr[0];
    else{
      const idx = arr.findIndex(x => x.id === navNode.id);
      navNode = arr[Math.min(arr.length-1, idx+1)];
    }
    cursor = navNode;
    rebuildChessToNode(navNode, true);
    highlightActive(navNode.id);
    updateNavButtons();
  }

  btnStart.addEventListener("click",(e)=>{ e.stopPropagation(); hidePop(); goStart(); });
  btnPrev .addEventListener("click",(e)=>{ e.stopPropagation(); hidePop(); goPrev(); });
  btnNext .addEventListener("click",(e)=>{ e.stopPropagation(); hidePop(); goNext(); });
  btnEnd  .addEventListener("click",(e)=>{ e.stopPropagation(); hidePop(); goEnd(); });

  document.addEventListener("keydown",(e)=>{
    const active = document.activeElement;
    const typing = active && (active.tagName === "TEXTAREA" || active.tagName === "INPUT");
    if(typing) return;
    if(pop.style.display !== "none") return;

    if(e.key === "Home"){ e.preventDefault(); goStart(); }
    else if(e.key === "End"){ e.preventDefault(); goEnd(); }
    else if(e.key === "ArrowLeft"){ e.preventDefault(); goPrev(); }
    else if(e.key === "ArrowRight"){ e.preventDefault(); goNext(); }
  });

  // ---------- Clipboard ----------
  function writeClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    return Promise.resolve();
  }
  document.getElementById("copyPGN").addEventListener("click",(e)=>{ e.stopPropagation(); writeClipboard(pgnText.value); });
  document.getElementById("copyFEN").addEventListener("click",(e)=>{ e.stopPropagation(); writeClipboard(currentFEN); });

  // ---------- Variation-correct insertion ----------
  function addMoveToTree(san){
    // follow mainline if matching
    if(cursor.next && cursor.next.san === san){
      cursor = cursor.next;
      return;
    }
    // follow existing variation if matching
    const existingVar = cursor.variations.find(v => v.san === san);
    if(existingVar){
      cursor = existingVar;
      return;
    }
    // create new node
    const newNode = new Node(san, cursor);
    if(cursor.next){
      // mainline exists but differs => this is a variation
      cursor.variations.push(newNode);
    }else{
      // no mainline => becomes mainline
      cursor.next = newNode;
    }
    cursor = newNode;
  }

  // ---------- Promotion ----------
  let pendingPromotion = null;

  function commitPromotion(p){
    if(!pendingPromotion){ hidePop(); return; }
    chess.load(pendingPromotion.fenBefore);

    const m = chess.move({
      from: pendingPromotion.from,
      to: pendingPromotion.to,
      promotion: p
    });

    if(!m){
      pendingPromotion = null;
      hidePop();
      setBoardFen(chess.fen(), false);
      return;
    }

    addMoveToTree(m.san);

    pendingPromotion = null;
    hidePop();

    setBoardFen(chess.fen(), false);
    if(isOnMainline(cursor)) navNode = cursor;

    renderAll();
    syncPGN();
    highlightActive(cursor.id);
    updateNavButtons();
  }

  // ---------- onDrop (promotion + legality) ----------
  function onDrop(from, to){
    hidePop();

    const test = new Chess(chess.fen());
    const mQ = test.move({ from, to, promotion:"q" });
    if(!mQ) return "snapback";

    const isPromotion = !!(mQ.flags && mQ.flags.indexOf("p") !== -1);

    if(isPromotion){
      pendingPromotion = { from, to, fenBefore: chess.fen() };
      openPromotionPop(pendingPromotion);
      return "snapback"; // required sync return for chessboard.js
    }

    const m = chess.move({ from, to, promotion:"q" });
    if(!m) return "snapback";

    addMoveToTree(m.san);

    setBoardFen(chess.fen(), false);

    if(isOnMainline(cursor)) navNode = cursor;

    renderAll();
    syncPGN();
    highlightActive(cursor.id);
    updateNavButtons();
  }

  // ---------- Init ----------
  showTab("moves");
  renderAll();
  syncPGN();
  updateNavButtons();
  rebuildChessToNode(root, false);
  window.addEventListener("resize", () => board.resize());
})();
</script>

</body>
</html>
