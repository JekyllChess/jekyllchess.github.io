<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>JekyllChess PGN App</title>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0f1115;
  color:#e6e6e6;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
.top{
  padding:10px 14px;
  background:#171a21;
  border-bottom:1px solid #222;
  display:flex;
  gap:10px;
  align-items:center;
}
.top img{width:22px;filter:invert(1)}

.wrap{padding:12px}
.main{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.main{grid-template-columns:560px 1fr}}
#board{width:min(92vw,560px);margin:0 auto}

.controls{display:flex;gap:6px;margin-top:8px}
.controls button{
  flex:1;padding:10px;border:none;border-radius:10px;
  background:#1f2430;color:#ddd;cursor:pointer;font-size:15px;
}

.card{border:1px solid #222;border-radius:12px;overflow:hidden}
.cardHead{padding:10px 12px;background:#141820;border-bottom:1px solid #222;font-weight:700}
.cardBody{padding:12px}

.moves{font-size:18px;line-height:2}
.move{display:inline-block;padding:2px 6px;border-radius:7px;cursor:pointer}
.move.active{background:#3a7afe;color:#fff}

.variation{margin-left:26px;padding-left:10px;border-left:2px dashed #444}

/* promotion chooser */
#promo{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
#promo .box{background:#161a24;padding:16px;border-radius:12px;display:flex;gap:10px}
#promo button{
  font-size:28px;padding:10px 14px;background:#1f2430;
  border:none;border-radius:10px;color:#fff;cursor:pointer
}
</style>
</head>

<body>

<div class="top">
  <img src="https://jekyllchess.github.io/assets/favicon.png">
  <div>JekyllChess PGN App</div>
</div>

<div class="wrap">
  <div class="main">
    <div>
      <div id="board"></div>
      <div class="controls">
        <button id="btnStart">⏮</button>
        <button id="btnPrev">◀</button>
        <button id="btnNext">▶</button>
        <button id="btnEnd">⏭</button>
      </div>
    </div>
    <div class="card">
      <div class="cardHead">Move list</div>
      <div class="cardBody">
        <div id="moves" class="moves"></div>
      </div>
    </div>
  </div>
</div>

<div id="promo">
  <div class="box">
    <button data-p="q">♕</button>
    <button data-p="r">♖</button>
    <button data-p="b">♗</button>
    <button data-p="n">♘</button>
  </div>
</div>

<script>
(() => {

const FIG={K:"♔",Q:"♕",R:"♖",B:"♗",N:"♘"};
const figSAN=s=>s.replace(/^[KQRBN]/,p=>FIG[p]||p);

let ID=1;
class Node{
  constructor(san,parent,fen){
    this.id="n"+ID++;
    this.san=san;
    this.parent=parent;
    this.fen=fen;     // ALWAYS a valid FEN string
    this.next=null;
    this.vars=[];
  }
}

const START_FEN = new Chess().fen();
const root=new Node(null,null,START_FEN);

let cursor=root;
let navNode=root;

const chess=new Chess();
const board=Chessboard("board",{
  position:"start",
  draggable:true,
  pieceTheme:"https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
  onDrop
});

/* ───────── Rebuild (FEN-based & safe) ───────── */

function rebuildTo(node,animate){
  const fen = (node && node.fen) ? node.fen : START_FEN;

  // chess.load returns true/false
  const ok = chess.load(fen);

  if(!ok){
    chess.reset();
    board.position("start", !!animate);
    return;
  }

  board.position(chess.fen(), !!animate);
}

/* ───────── Promotion handling ───────── */

let pending=null;
const promo=document.getElementById("promo");

function onDrop(from,to){
  const test=new Chess(chess.fen());
  const piece=test.get(from);
  const isPromo=piece?.type==="p" && (to[1]==="8" || to[1]==="1");

  if(isPromo){
    pending={from,to};
    promo.style.display="flex";
    return;
  }

  const m=test.move({from,to,promotion:"q"});
  if(!m) return "snapback";

  applyMove(m.san, test.fen());
}

promo.onclick=e=>{
  if(!e.target.dataset.p) return;

  promo.style.display="none";

  const test=new Chess(chess.fen());
  const m=test.move({from:pending.from, to:pending.to, promotion:e.target.dataset.p});
  pending=null;

  if(!m) return;
  applyMove(m.san, test.fen());
};

/* ───────── Apply move (ensures FEN even on reuse) ───────── */

function applyMove(san,fen){
  let n=null;

  // reuse mainline if identical SAN
  if(cursor.next && cursor.next.san===san){
    n = cursor.next;
    // IMPORTANT: ensure fen is stored (or refreshed)
    n.fen = fen || n.fen;
  }else{
    // reuse existing variation move if identical SAN
    const v = cursor.vars.find(x=>x.san===san);
    if(v){
      n = v;
      n.fen = fen || n.fen;
    }else{
      // create new node
      n = new Node(san,cursor,fen);
      if(cursor.next) cursor.vars.push(n);
      else cursor.next=n;
    }
  }

  cursor = navNode = n;
  rebuildTo(n,false);
  render();
}

/* ───────── Rendering ───────── */

const movesDiv=document.getElementById("moves");

function render(){
  movesDiv.innerHTML="";

  function line(start,ply,wrap){
    let n=start.next;
    while(n){
      const span=document.createElement("span");
      span.className="move"+(n===cursor?" active":"");
      const num=ply%2===0 ? (Math.floor(ply/2)+1+". ") : "";
      span.textContent=num+figSAN(n.san)+" ";

      span.onclick=()=>{
        // clicking MUST be pure navigation; never depends on mainline/variation logic
        cursor = navNode = n;
        rebuildTo(n,true);
        render();
      };

      wrap.appendChild(span);

      if(n.vars.length){
        n.vars.forEach(v=>{
          const d=document.createElement("div");
          d.className="variation";
          wrap.appendChild(d);
          line({next:v},ply+1,d);
        });
      }

      n=n.next; ply++;
    }
  }

  line(root,0,movesDiv);
}

/* ───────── Buttons ───────── */

btnStart.onclick=()=>{cursor=navNode=root;rebuildTo(root,true);render();}
btnEnd.onclick=()=>{let n=root;while(n.next)n=n.next;cursor=navNode=n;rebuildTo(n,true);render();}
btnPrev.onclick=()=>{if(navNode.parent){cursor=navNode=navNode.parent;rebuildTo(navNode,true);render();}}
btnNext.onclick=()=>{if(navNode.next){cursor=navNode=navNode.next;rebuildTo(navNode,true);render();}}

/* ───────── Keyboard navigation (← →) ───────── */

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft"){
    if(navNode.parent){
      cursor=navNode=navNode.parent;
      rebuildTo(navNode,true);
      render();
    }
  }else if(e.key==="ArrowRight"){
    if(navNode.next){
      cursor=navNode=navNode.next;
      rebuildTo(navNode,true);
      render();
    }
  }
});

/* ───────── Init ───────── */

render();
rebuildTo(root,false);

})();
</script>

</body>
</html>
